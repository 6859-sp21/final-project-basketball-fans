<!DOCTYPE html style="height: 100%">
<meta charset="utf-8" />
<!-- <link rel="icon" href="./favicon.ico" type="image/x-icon">  -->
<!-- <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon"> -->
<link rel="stylesheet" href="./style.css">
<body>
  <svg height="0">
    <defs>
      <linearGradient id="grad2" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" style="stop-color:rgb(0,0,0);stop-opacity:1" />
        <stop offset="100%" style="stop-color:rgb(0,0,0);stop-opacity:0" />
      </linearGradient>
    </defs>
  </svg>
  <h1>Shot Chart for <span id="game_id"></span></h1>
  <select name="Game" id="choosegame">

  </select>
  <div id="my_dataviz" style="height: calc(100% - 80px)"></div>
</body>
<script src="https://d3js.org/d3.v6.js"></script>
<script src="https://unpkg.com/d3-simple-slider"></script>

<script type="module">
             var stringToColor = function(str) {
        var hash = 0;
        for (var i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        var colour = '#';
        for (var i = 0; i < 3; i++) {
            var value = (hash >> (i * 8)) & 0xFF;
            colour += ('00' + value.toString(16)).substr(-2);
        }
        return colour;
        }

  const dataUrl =
    "https://raw.githubusercontent.com/6859-sp21/final-project-basketball-fans/main/shot_data_2019.json";
  const playerImagesUrl =
    "https://raw.githubusercontent.com/6859-sp21/final-project-basketball-fans/main/playerImages.json";
 
  const coord = (str) => {
    return parseFloat(str.substring(0, str.length - 3))
  }
  let data = await d3.json(dataUrl)
  let select = document.getElementById('choosegame')
   let firstGameId = ""
   for (const gameId in data) {
       if(firstGameId === "") firstGameId = gameId 
       var option = document.createElement('option')
       option.value = gameId 
       let gameData = data[gameId]
       option.innerHTML = gameData['home'] + " - " + gameData['visitor'] + " (" + gameData['date'] + ")"
       select.appendChild(option)
   }
   select.value = firstGameId 
   select.onchange = (event) => {
       updateShotChart(event.target.value)
   }
  let playerImages = await d3.json(playerImagesUrl)
    // Setting up variables that describe our chart's space.
    const margin = { top: 30, right: 30, bottom: 30, left: 30 };

    // append the svg object to the body of the page
    var svg = d3
      .select("#my_dataviz")
      .append("svg")
      .attr("width", "100%")
      .attr("height", "100%")
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var currentGameID = firstGameId

    function updateShotChart(gameID) { // this will need to take time as input once we animate
      
     

      const width = window.innerWidth - margin.left - margin.right;
      const height = window.innerHeight - margin.top - margin.bottom - 80;
      const gameData = data[gameID]
      let shots = data[gameID]['shots_home']
      shots = shots.filter((entry)=>{return entry.MAKE_MISS == 'MAKE'})
      currentGameID = gameID 
      d3.select('#game_id').text(gameData['home'] + " - " + gameData['visitor'] + " (" + gameData['date'] + ")");
      let duration = 2000
      let image = svg
        .selectAll('g')
        .data(shots, (d, i) => {return (i) + (d.PLAYER) + (d.TIME_REMAINING) + (d.x) + (d.y) })
        .join(
          enter => {
            // G IS THE GROUP OF IMAGE AND TEXT/RECTANGLE
            let g = enter.append('g').attr("overflow", "hidden");
            g.call(enter => enter.transition().duration(duration)
            .attr('transform', function (d) { 
              return "translate(" + 20*coord(d.x) + "," + 15*coord(d.y) + ")"
            }))

            g.append('circle')
              
              .attr('fill', (d)=>{return stringToColor(d.PLAYER)})
              .call(enter => enter.transition()
              .attr('r', 0)
              .attr('cx', 0)
              .attr('cy', 0)
              .duration(duration)
              .attr('r', 25)
              .attr('cx', 20)
              .attr('cy', 20)
              );

            g.append('clipPath')
              .attr('id', (d,i) => i)
              .append('circle')
              .call(enter => enter.transition()
              .attr('r', 0)
              .attr('cx', 0)
              .attr('cy', 0)
              .duration(duration)
              .attr('r', 20)
              .attr('cx', 20)
              .attr('cy', 20)
              );
              // THE RECT
            let image =  g.append('svg:image')
               .attr('xlink:href', function (d) {return playerImages[d.PLAYER] } )
              .attr("preserveAspectRatio", "xMinYMin slice")
              .attr('clip-path', (d,i) => `url(#${i})`)
              
              
            image.call(enter => enter.transition()
            .attr('x', 0)
            .attr('y', 0)
              .attr('width', 0)
              .attr('height', 0)
              .duration(duration)
              .attr('width', 40)
              .attr('height', 40))

            },
          update => update,
          exit => {
              exit.select("image").call(exit1 => exit1.transition().duration(duration)
              .attr('width', 0)
              .attr('height', 0)
              )
              exit.select("circle").call(exit1 => exit1.transition().duration(duration)
              .attr('r', 0)
              )

              exit.select("clipPath").select("circle").call(exit1 => exit1.transition().duration(duration)
              .attr('r', 0)
              )

              exit.call(exit1 => exit1.transition().delay(duration)
              .remove())  
          }     
        )
        
        
        
    }
    updateShotChart(currentGameID)          

</script>
